<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donatcal Vue 版本</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body class="d-flex flex-column h-100">
  <main class="flex-shrink-0">
    <div class="container-fluid bg-success">
      <div class="p-5 bg-success text-white text-center">
        <h1 class="display-1">Donatcal with Vue</h1>
        <p>積分制計算器，為目標而戰！</p>
      </div>
    </div>

    <div id="app" class="container-fluid">
      <div class="shadow row bg-secondary text-light text-center">
        <div class="col-md-6">
          <h2>目標分數：{{ target }}</h2>
        </div>
        <div class="col-md-6">
          <h2>當前分數：{{ score }}</h2>
        </div>
      </div>
      
      <div class="container">
        <div class="row mt-4">
          <!-- 左側控制面板 -->
          <div class="col-md-4 mt-4">
            <!-- 初始設定區塊 -->
            <div id="initFormBox" class="shadow-lg rounded row bg-light">
              <div class="row py-2">
                <div class="col-12">
                  <button id="initBtn" type="button" class="shadow-sm btn rounded" data-bs-toggle="collapse" data-bs-target="#initForm">
                    初始設定
                  </button>
                </div>
              </div>

              <section id="initForm" class="collapse show">
                <div class="row mb-3">
                  <div class="col-6">
                    <label for="playersNum" class="form-label">選擇人數:</label>
                    <select class="form-select" :disabled="!initActive" v-model.number="playersNum" name="playersNum" id="playersNum">
                      <option v-for="i in maxPlayers" :key="i" :value="i">{{ i }}</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label for="tgip" class="form-label">請輸入目標值:</label>
                    <input type="number" :disabled="!initActive" v-model.number="target" class="form-control" name="tgip" id="tgip" pattern="[0-9]*" aria-describedby="tgipHelp" placeholder="">
                    <small id="tgipHelp" class="form-text text-muted">分數達到目標值將結束流程</small>
                  </div>
                </div>

                <div class="row">
                  <div class="d-grid">
                    <button type="submit" id="initSubmit" class="btn btn-primary mb-2" @click="initSubmit" :disabled="!initActive">
                      提交
                    </button>
                  </div>
                </div>
              </section>
            </div>

            <!-- 分數輸入區塊 -->
            <div id="scoreInputBox" class="shadow-lg rounded row bg-light mt-3">
              <div class="row py-2">
                <div class="col-12">
                  <button id="scipBtn" type="button" class="shadow-sm btn rounded" data-bs-toggle="collapse" data-bs-target="#scip">
                    錄入分數
                  </button>
                </div>
              </div>

              <section id="scip" class="collapse">
                <div id="iterableScoreForm">
                  <template v-if="!initActive">
                    <!-- 局數顯示 -->
                    <div id="gameCountArea" class="row">
                      <div class="text-center">
                        <h5>第 {{ Math.max(1, game) }} 局</h5>
                      </div>
                    </div>
                    
                    <!-- 玩家分數輸入 -->
                    <div v-for="player in players" :key="player.id" class="row mb-3 align-items-center">
                      <div class="col-2">
                        <input type="color" class="form-control form-control-color" v-model="player.borderColor" :disabled="initActive">
                      </div>
                      <div class="col-1 text-end">
                        <button class="btn btn-sm btn-outline-secondary" type="button" @click="toggleEditName(player.id)">
                          ✏️
                        </button>
                      </div>
                      <div v-if="editingPlayerId === player.id" class="col-5">
                        <input type="text" v-model="player.name" class="form-control" @blur="finishEditName" @keyup.enter="finishEditName">
                      </div>
                      <label v-else :for="'g'+game+'-'+player.name" class="col-5 col-form-label">{{ player.name }}</label>
                      <div class="col-4">
                        <input type="number" class="form-control" :id="'g'+game+'-'+player.name" v-model.number="player.currentScore" pattern="[0-9]*" min="0">
                      </div>
                    </div>
                  </template>
                </div>

                <div class="row">
                  <div class="d-grid">
                    <button id="scsm" type="submit" @click="scoreSubmit" :disabled="initActive" class="btn btn-primary mb-2">
                      錄入
                    </button>
                  </div>
                </div>
              </section>
            </div>
          </div>

          <!-- 右側圖表區域 -->
          <div class="col-md-8 my-4">
            <div class="shadow-lg rounded bg-light text-center">
              <canvas id="lineChart" style="width: 100%; height: 600px;"></canvas>
            </div>
          </div>
        </div>

        <!-- 分數表格 -->
        <div class="row shadow-lg rounded bg-white my-4">
          <div class="col overflow-auto">
            <table class="table text-center" v-if="!initActive">
              <thead>
                <tr>
                  <th>局數</th>
                  <th v-for="player in players" :key="player.id">
                    {{ player.name }}
                    <p class="mb-0">{{ getSum(player.id) }}</p>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="round in Math.max(0, game - 1)" :key="round">
                  <th scope="row">{{ round }}</th>
                  <td v-for="player in players" :key="player.id">{{ getScore(player.id, round) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer mt-auto py-3 bg-light">
    <div class="container">
      Copyright @2024 Ted WU
    </div>
  </footer>

  <script>
    const { createApp } = Vue;
    
    createApp({
      data() {
        return {
          playersNum: 2,
          maxPlayers: 8,
          score: 0,
          target: 100,
          initActive: true,
          game: 0,
          editingPlayerId: null,
          players: [],
          chart: null
        };
      },

      computed: {
        chartConfig() {
          if (this.players.length === 0 || this.game <= 1) return null;
          
          const gameNumLabel = _.range(1, this.game);
          const datasets = this.players.map(player => ({
            label: player.name || `玩家${player.id + 1}`,
            data: this.getPlayerChartData(player.id),
            fill: false,
            borderColor: player.borderColor || '#000000',
            backgroundColor: (player.borderColor || '#000000') + '20',
            tension: 0.3
          })).filter(dataset => dataset.data && dataset.data.length > 0);

          if (datasets.length === 0) return null;

          return {
            type: 'line',
            data: {
              labels: gameNumLabel,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                title: {
                  display: true,
                  text: '時局圖',
                  font: { size: 20 }
                },
                legend: {
                  display: true,
                  position: 'top'
                }
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: '局數'
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: '分數'
                  },
                  suggestedMin: 0,
                  ticks: {
                    stepSize: 5
                  }
                }
              }
            }
          };
        }
      },

      methods: {
        initSubmit() {
          if (this.playersNum < 1 || this.playersNum > this.maxPlayers) {
            alert('請選擇有效的人數（1-8人）');
            return;
          }
          
          if (this.target <= 0) {
            alert('請輸入有效的目標分數');
            return;
          }

          this.game = 1;
          this.players = [];
          
          for (let i = 0; i < this.playersNum; i++) {
            const rawPlayer = {
              id: i,
              name: `玩家${i + 1}`,
              borderColor: "#" + ('00000' + (Math.random() * (1 << 24) | 0).toString(16)).slice(-6),
              score: [],
              currentScore: 0
            };
            this.players.push(rawPlayer);
          }

          // 關閉初始設定面板
          const initBtn = document.querySelector('#initBtn');
          if (initBtn) initBtn.click();
          
          this.initActive = false;
          
          // 自動打開分數輸入面板
          setTimeout(() => {
            const scipBtn = document.querySelector('#scipBtn');
            if (scipBtn) scipBtn.click();
          }, 200);

          // 初始化圖表
          this.$nextTick(() => {
            this.initChart();
          });
        },

        initChart() {
          if (this.chartConfig) {
            const ctx = document.getElementById('lineChart');
            if (ctx) {
              this.chart = new Chart(ctx.getContext('2d'), this.chartConfig);
            }
          }
        },

        scoreSubmit() {
          if (!this.validateCurrentScores()) {
            alert('請輸入有效的分數（不能為負數）');
            return;
          }

          let roundTotal = 0;
          this.players.forEach(player => {
            player.score.push(player.currentScore);
            roundTotal += player.currentScore;
            player.currentScore = 0;
          });

          this.score += roundTotal;
          
          // 更新圖表
          if (this.chart) {
            this.players.forEach((player, index) => {
              this.chart.data.datasets[index].data = this.getPlayerChartData(player.id);
              this.chart.data.datasets[index].label = player.name;
              this.chart.data.datasets[index].borderColor = player.borderColor;
            });
            
            this.chart.data.labels = _.range(1, this.game);
            this.chart.update();
          }

          this.game++;

          // 檢查是否達到目標
          if (this.checkGameEnd()) {
            this.handleGameEnd();
          }
        },

        validateCurrentScores() {
          return this.players.every(player => 
            player.currentScore >= 0 && !isNaN(player.currentScore)
          );
        },

        checkGameEnd() {
          return this.players.some(player => this.getSum(player.id) >= this.target);
        },

        handleGameEnd() {
          const winner = this.players.find(player => 
            this.getSum(player.id) >= this.target
          );
          
          if (winner) {
            setTimeout(() => {
              alert(`恭喜 ${winner.name} 獲得勝利！\n最終分數：${this.getSum(winner.id)}`);
            }, 100);
          }
        },

        getScore(playerId, round) {
          const player = this.players.find(p => p.id === playerId);
          return player && player.score ? player.score[round - 1] || 0 : 0;
        },

        getSum(playerId) {
          const player = this.players.find(p => p.id === playerId);
          return player && player.score ? _.sum(player.score) : 0;
        },

        getPlayerChartData(playerId) {
          const player = this.players.find(p => p.id === playerId);
          if (!player || !player.score) return [];
          
          const cumulativeScores = [];
          let sum = 0;
          for (let score of player.score) {
            sum += Number(score) || 0;
            cumulativeScores.push(sum);
          }
          return cumulativeScores;
        },

        toggleEditName(playerId) {
          this.editingPlayerId = this.editingPlayerId === playerId ? null : playerId;
        },

        finishEditName() {
          this.editingPlayerId = null;
        },

        resetGame() {
          this.players = [];
          this.score = 0;
          this.game = 0;
          this.initActive = true;
          
          if (this.chart) {
            this.chart.destroy();
            this.chart = null;
          }
        }
      },

      mounted() {
        // 頁面加載完成後的初始化
        console.log('Donatcal Vue version loaded');
      }
    }).mount('#app');
  </script>
</body>
</html>